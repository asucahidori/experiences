var container,stats;var camera,scene,renderer,controls;var cameraOrtho,sceneOrtho;var plane;var targetRotation=0;var targetRotationOnMouseDown=0;var mouseX=0;var mouseXOnMouseDown=0;var widthPercent=1;var heightPercent=1;var windowHalfX=window.innerWidth/2;var windowHalfY=window.innerHeight/2;var canvasWidth=window.innerWidth*widthPercent;var canvasHeight=window.innerHeight*heightPercent;var unitNum=4;var totalFloor=15;var floorHeight=30;var floorBet=3;var cubeX=200;var cubeZ=cubeX*unitNum;var unitRoomNum=4;var colRow=unitRoomStructure(unitRoomNum);var hxRow=colRow[0];var hxColumn=colRow[1];var unitRoomIndex=1;var unitZ=cubeZ/unitNum;var unitX=cubeX;var evX=unitX/hxRow;var evZ=unitZ/hxColumn;var liftX=40;var liftZ=60;var topCubeX=60;var topCubeZ=60;var topCubeY=40;var buildminx=-(cubeX/2);var buildmaxx=cubeX/2;var buildminz=-cubeZ/2;var buildmaxz=cubeZ/2;var buildHeight=totalFloor*(floorHeight+floorBet);var projector,mouse={x:0,y:0},INTERSECTED;var sprite1;var canvas1,context1,texture1;var FLOOR="floor";var UNIT="unit";var GROUND="ground";var currentOutFloor;var outPositionX=cubeX+100;var houseTypes=[];var flag=false;var typeGrids=[];var CHART="chart";var zhuEnable=false;var zwidth=12;var zOriginalHeight=10;var zhus=[];var text3Ds=[];var fontSize3D=10;var peopleColor=16732714;var incomeColor=45296;var costColor=16449778;var orderNumColor=15985421;var orderbookColor=527710;var incomeEnable=false;var costEnable=false;var orderNumEnable=false;var orderbookEnable=false;var incomeZhu=[];var costZhu=[];var orderNumZhu=[];var orderbookZhu=[];var incomeText=[];var costText=[];var orderNumText=[];var orderbookText=[];var dis=liftZ/2+(unitZ/2-liftZ/2)/2;var textureFloor;init();animate();function init(){container=document.getElementById("container");document.body.appendChild(container);scene=new THREE.Scene();scene.fog=new THREE.Fog(14215167,1000,10000);camera=new THREE.PerspectiveCamera(70,canvasWidth/canvasHeight,1,5000);camera.position.set(1000,500,0);var v=new THREE.DirectionalLight(16777215,0.3);v.position.set(300,300,0);v.castShadow=true;scene.add(v);var O=new THREE.HemisphereLight(16777215,16777215,0.9);O.position.y=2000;scene.add(O);var I=THREE.ImageUtils.loadTexture("../photo/80lb-Felt-Granite.jpg");var B=new THREE.MeshPhongMaterial({map:I,side:THREE.DoubleSide});var l=new THREE.PlaneGeometry(1000,1000);var b=new THREE.Mesh(l,B);b.position.y=-0.5;b.rotation.x=Math.PI/2;b.type=GROUND;scene.add(b);textureFloor=THREE.ImageUtils.loadTexture("../photo/80lb-Felt-Granite.jpg");for(var Q=1;Q<=totalFloor;Q++){var o=new THREE.CubeGeometry(cubeX,floorHeight,cubeZ);var f=new THREE.CubeGeometry(cubeX,floorBet,cubeZ);var d=new THREE.Mesh(o,new THREE.MeshPhongMaterial({map:textureFloor,side:THREE.DoubleSide,shading:THREE.SmoothShading}));d.position.y=(Q-1)*(floorHeight+floorBet)+floorHeight/2;d.material.side=THREE.DoubleSide;d.name=Q+"层";d.type=FLOOR;scene.add(d);var g=new THREE.Mesh(f,new THREE.MeshPhongMaterial({color:8091271,side:THREE.DoubleSide,shading:THREE.SmoothShading}));g.position.y=(Q-1)*(floorHeight+floorBet)+(floorHeight+floorBet/2);g.material.side=THREE.DoubleSide;scene.add(g)}for(var Q=1;Q<=unitNum;Q++){var o=new THREE.CubeGeometry(liftX,buildHeight,liftZ);var s=new THREE.Mesh(o,new THREE.MeshPhongMaterial({map:textureFloor,side:THREE.DoubleSide,shading:THREE.SmoothShading}));s.position.x=buildmaxx+liftX/2;s.position.y=buildHeight/2;s.position.z=buildmaxz-(Q-1)*unitZ-unitZ/2;s.material.side=THREE.DoubleSide;s.name=Q+"单元";s.type=UNIT;scene.add(s)}for(var Q=1;Q<=unitNum;Q++){var o=new THREE.CubeGeometry(topCubeX,topCubeY,topCubeZ);var K=new THREE.Mesh(o,new THREE.MeshPhongMaterial({map:textureFloor,side:THREE.DoubleSide,shading:THREE.SmoothShading}));K.position.x=0;K.position.y=buildHeight+topCubeY/2;K.position.z=buildmaxz-(Q-1)*unitX-unitX/2;K.material.side=THREE.DoubleSide;K.name=Q+"单元";scene.add(K)}if(Detector.webgl){renderer=new THREE.WebGLRenderer({antialias:true})}else{renderer=new THREE.CanvasRenderer()}renderer.setClearColor(2703200);renderer.setSize(canvasWidth,canvasHeight);container.appendChild(renderer.domElement);controls=new THREE.OrbitControls(camera,renderer.domElement);controls.addEventListener("change",render);controls.initPosition(0,30,0);stats=new Stats();stats.domElement.style.position="absolute";stats.domElement.style.bottom="0px";stats.domElement.style.zIndex=100;container.appendChild(stats.domElement);projector=new THREE.Projector();var S=document.createElement("canvas");S.width=176;S.height=134;var k=S.getContext("2d");var G=new Image();G.src="../photo/window001.jpg";if(G.complete){k.drawImage(G,0,0,176,134,0,0,176,134);drawWindows(S)}else{G.onload=function(){k.drawImage(G,0,0,176,134,0,0,176,134);drawWindows(S)};G.onerror=function(){window.alert("窗户加载失败，请重试")}}var H=document.createElement("canvas");H.width=32;H.height=23;var N=H.getContext("2d");var E=new Image();E.src="../photo/window3.jpg";if(E.complete){N.drawImage(E,0,0,32,23,0,0,32,23);drawBackWindows(H)}else{E.onload=function(){N.drawImage(E,0,0,32,23,0,0,32,23);drawBackWindows(H)};E.onerror=function(){window.alert("窗户加载失败，请重试")}}var a=document.createElement("canvas");a.width=535;a.height=636;var e=a.getContext("2d");var T=new Image();T.src="../photo/unit_door4.jpg";if(T.complete){e.drawImage(T,0,0,535,636,0,0,535,636);drawDoors(a)}else{T.onload=function(){e.drawImage(T,0,0,535,636,0,0,535,636);drawDoors(a)};T.onerror=function(){window.alert("单元门加载失败，请重试")}}J:for(var F=1;F<=unitNum;F++){var J=new Object();J.x=0;J.z=buildmaxz-(F-1)*unitZ+unitZ/2;J.y=0;J.minx=-unitX/2;J.maxx=unitX/2;J.minz=buildmaxz-F*unitZ;J.maxz=buildmaxz-(F-1)*unitZ;row:for(var Q=1;Q<=hxRow;Q++){column:for(var P=1;P<=hxColumn;P++){var R=new THREE.PlaneGeometry(unitX/hxRow-4,unitZ/hxColumn-4);var w=new THREE.Mesh(R,new THREE.MeshBasicMaterial({color:14078158}));w.rotation.x=-90*Math.PI/180;var C=J.maxx-(Q-1)*evX-evX/2;var A=J.maxz-(P-1)*evZ-evZ/2;w.position.set(C,0,A);w.outX=C+outPositionX;unitRoomIndex=(Q-1)*hxColumn+P;scene.add(w);typeGrids.push(w);if(unitRoomIndex>unitRoomNum){continue column}w.name=F+"-10"+unitRoomIndex;var q=document.createElement("canvas");q.height=30;q.width=130;var m=q.getContext("2d");m.font="500 38px normal";m.fillStyle="rgba(0,0,0,0.95)";m.fillText(w.name,0,30);var M=new THREE.Texture(q);M.needsUpdate=true;var p=new THREE.MeshBasicMaterial({map:M,color:16777215});p.transparent=true;var L=new THREE.PlaneGeometry(40,15);var D=new THREE.Mesh(L,p);D.rotation.z=90*Math.PI/180;D.rotation.x=-90*Math.PI/180;D.position.set(C,0,A);D.outX=C+outPositionX;D.name=w.name;D.familyNumber=Math.ceil(Math.random()*8);var n=1+Math.random()*4;D.income=n.toFixed(1)+"";var c=n*(0.2+Math.random()*0.4);D.cost=c.toFixed(1)+"";var r=Math.floor(Math.random()*6);D.orderNum=r+"";var t=Math.random()*0.2*c;t=t>0?t.toFixed(1):0;D.orderbook=t+"";D.context=m;D.texture=M;scene.add(D);houseTypes.push(D)}}}canvas1=document.createElement("canvas");context1=canvas1.getContext("2d");context1.font="Bold 20px Arial";context1.fillStyle="rgba(0,0,0,0.95)";context1.fillText("Hello, world!",0,20);texture1=new THREE.Texture(canvas1);texture1.needsUpdate=true;var h=new THREE.SpriteMaterial({map:texture1,useScreenCoordinates:true,alignment:THREE.SpriteAlignment.topLeft});sprite1=new THREE.Sprite(h);sprite1.scale.set(200,100,1);sprite1.position.set(50,50,0);scene.add(sprite1);document.addEventListener("mousemove",onDocumentMouseMove,false);document.addEventListener("mousedown",onDocumentMouseDown,false);window.addEventListener("resize",onWindowResize,false)}function drawWindows(d){var m=new THREE.Texture(d);m.needsUpdate=true;var a=new THREE.MeshBasicMaterial({map:m,color:16777215});a.transparent=true;for(var i=1;i<=totalFloor;i++){for(var n=1;n<=unitNum;n++){var e=new THREE.PlaneGeometry(24,20);var c=new THREE.Mesh(e,a);c.rotation.y=Math.PI/2;var l=buildmaxx+liftX+1;var k=(i-1)*(floorHeight+floorBet)+floorHeight/2;var j=buildmaxz-(n-1)*unitZ-unitZ/2;c.position.set(l,k,j);if(i!=1){scene.add(c)}var o=new THREE.PlaneGeometry(24,20);var b=new THREE.Mesh(o,a);l=buildmaxx+1;j=buildmaxz-(n-1)*unitZ-unitZ/2+dis;b.position.set(l,k,j);b.rotation.y=Math.PI/2;scene.add(b);var g=new THREE.PlaneGeometry(24,20);var h=new THREE.Mesh(g,a);l=buildmaxx+1;j=buildmaxz-(n-1)*unitZ-unitZ/2-dis;h.position.set(l,k,j);h.rotation.y=Math.PI/2;scene.add(h)}}for(var i=1;i<=totalFloor;i++){var o=new THREE.PlaneGeometry(24,20);var b=new THREE.Mesh(o,a);var l=0;var k=(i-1)*(floorHeight+floorBet)+floorHeight/2;var j=buildmaxz+1;b.position.set(l,k,j);scene.add(b);var g=new THREE.PlaneGeometry(24,20);var h=new THREE.Mesh(g,a);j=buildminz-1;h.position.set(l,k,j);h.rotation.x=Math.PI;scene.add(h)}}function drawBackWindows(e){var h=new THREE.Texture(e);h.needsUpdate=true;var b=new THREE.MeshBasicMaterial({map:h,color:16777215});b.transparent=true;var c=2*unitNum;var j=cubeZ/c;for(var g=1;g<=totalFloor;g++){for(var i=1;i<=c;i++){var a=new THREE.PlaneGeometry(35,25);var d=new THREE.Mesh(a,b);x=buildminx-1;y=(g-1)*(floorHeight+floorBet)+floorHeight/2;z=buildmaxz-(i-1)*j-j/2;d.position.set(x,y,z);d.rotation.y=-Math.PI/2;scene.add(d)}}}function drawDoors(h){var j=new THREE.Texture(h);j.needsUpdate=true;var f=new THREE.MeshBasicMaterial({map:j,color:16777215});for(var p=1;p<=unitNum;p++){var d=new THREE.PlaneGeometry(25,25);var g=new THREE.Mesh(d,f);g.rotation.y=Math.PI/2;var o=buildmaxx+liftX+1;var n=floorHeight/2-2;var k=buildmaxz-(p-1)*unitZ-unitZ/2;g.position.set(o,n,k);g.rotation.y=Math.PI/2;scene.add(g);var c=getUnitName(p);var b=document.createElement("canvas");b.height=15;b.width=30;var e=b.getContext("2d");e.font="bold 500 30px normal";e.fillStyle="rgba(0,0,0,1)";e.fillText(c,0,10);var i=new THREE.Texture(b);i.needsUpdate=true;var m=new THREE.MeshBasicMaterial({map:i,color:16777215});m.transparent=true;var l=new THREE.PlaneGeometry(30,15);var a=new THREE.Mesh(l,m);a.rotation.y=Math.PI/2;n=floorHeight+floorBet/2;a.position.set(o,n,k);scene.add(a)}}function onWindowResize(){canvasWidth=window.innerWidth*widthPercent;canvasHeight=window.innerHeight*heightPercent;camera.aspect=canvasWidth/canvasHeight;camera.updateProjectionMatrix();renderer.setSize(canvasWidth,canvasHeight)}function onDocumentMouseMove(a){sprite1.position.set(a.clientX,a.clientY-20,100);mouse.x=(a.clientX/canvasWidth)*2-1;mouse.y=-(a.clientY/canvasHeight)*2+1}function onDocumentTouchStart(a){a.preventDefault();a.clientX=a.touches[0].clientX;a.clientY=a.touches[0].clientY;onDocumentMouseDown(a)}function onDocumentMouseDown(g){g.preventDefault();console.log("Click.");var b=new THREE.Vector3(mouse.x,mouse.y,1);projector.unprojectVector(b,camera);var a=new THREE.Raycaster(camera.position,b.sub(camera.position).normalize());var f=a.intersectObjects(scene.children);if(f.length>0){console.log("Hit @ "+toString(f[0].point));f[0].face.color.setRGB(0.8*Math.random()+0.2,0,0);f[0].object.geometry.colorsNeedUpdate=true;var d=f[0].object;var c=d.name;var e=d.type;if(e==null){if(c!=""&&c!="undefined"&&c!=null){setHouseTypePhoto(c)}}else{if(e==FLOOR){if(currentOutFloor!=null){if(currentOutFloor.id==d.id){}else{floorBack(currentOutFloor,d);currentOutFloor=d;floorOut(d)}}else{currentOutFloor=d;floorOut(d)}currentOutFloor=d}else{if(e==CHART){familyInfoShow(d)}}}}}function floorOut(b){var a=new Date();b.startMoveTime=a;new TWEEN.Tween(b.position).to({x:outPositionX,y:b.position.y,z:b.position.z},1000).easing(TWEEN.Easing.Exponential.InOut).start().onComplete(function(){zhuShow(b);incomeShow(b);costShow(b);orderNumShow(b);orderbookShow(b)});houseTypeMove();alphaCubeShow(b)}function floorBack(b,a){new TWEEN.Tween(b.position).to({x:0,y:b.position.y,z:b.position.z},1000).easing(TWEEN.Easing.Exponential.InOut).start();if(a==null){currentOutFloor=null;houseTypeBack()}zhuDisappear(zhus,text3Ds,"people");zhuDisappear(incomeZhu,incomeText,"income");zhuDisappear(costZhu,costText,"cost");zhuDisappear(orderNumZhu,orderNumText,"orderNum");zhuDisappear(orderbookZhu,orderbookText,"orderbook")}var alphaCube;function alphaCubeShow(a){if(alphaCube!=null){scene.remove(alphaCube)}var b=new THREE.CubeGeometry(cubeX,floorHeight,cubeZ);alphaCube=new THREE.Mesh(b,new THREE.MeshPhongMaterial({map:textureFloor,side:THREE.DoubleSide,opacity:0.3,transparent:true,shading:THREE.SmoothShading}));alphaCube.position.set(0,a.position.y,0);alphaCube.material.side=THREE.DoubleSide;scene.add(alphaCube)}function alphaCubeHide(){if(alphaCube!=null){scene.remove(alphaCube)}}function houseTypeMove(){for(index in typeGrids){new TWEEN.Tween(typeGrids[index].position).to({x:typeGrids[index].outX,y:currentOutFloor.position.y+floorHeight/2+1,z:typeGrids[index].position.z},1000).easing(TWEEN.Easing.Exponential.InOut).start()}for(index in houseTypes){new TWEEN.Tween(houseTypes[index].position).to({x:houseTypes[index].outX,y:currentOutFloor.position.y+floorHeight/2+2,z:houseTypes[index].position.z},1000).easing(TWEEN.Easing.Exponential.InOut).start()}houseTypeTextChange()}function houseTypeBack(){for(index in houseTypes){new TWEEN.Tween(houseTypes[index].position).to({x:typeGrids[index].outX-outPositionX,y:0,z:houseTypes[index].position.z},1000).easing(TWEEN.Easing.Exponential.InOut).start()}for(index in typeGrids){new TWEEN.Tween(typeGrids[index].position).to({x:typeGrids[index].outX-outPositionX,y:0,z:typeGrids[index].position.z},1000).easing(TWEEN.Easing.Exponential.InOut).start()}houseTypeTextChange()}function houseTypeTextChange(){var a="1";if(currentOutFloor!=null){a=currentOutFloor.name.substring(0,currentOutFloor.name.length-1);flag=true}else{flag=false}for(index in houseTypes){var b=houseTypes[index].name;houseTypes[index].name=b.substring(0,2)+a+b.substring(b.length-2);houseTypes[index].context.clearRect(0,0,300,300);houseTypes[index].context.fillText(houseTypes[index].name,0,30);houseTypes[index].texture.needsUpdate=true}for(index in typeGrids){var b=typeGrids[index].name;if(b==""||b==null||b==undefined){break}typeGrids[index].name=b.substring(0,2)+a+b.substring(b.length-2)}}function zhuShow(d){if(zhuEnable==false){return}if(currentOutFloor==null){return}if(currentOutFloor.name!=d.name){return}var c=new Date();if((c.getTime()-d.startMoveTime.getTime())<1000){return}if(zhus.length==0){for(index in houseTypes){var b=houseTypes[index];var f=new THREE.CubeGeometry(zwidth,zOriginalHeight,zwidth);var a=new THREE.Mesh(f,new THREE.MeshPhongMaterial({color:peopleColor,opacity:0.5,transparent:true}));a.position.set(b.position.x-(evX/2-zwidth/2)+zwidth/2,b.position.y+zOriginalHeight/2,b.position.z-(evZ/2-zwidth/2)+zwidth/2);a.material.side=THREE.DoubleSide;a.name=b.familyNumber;a.familyNumber=b.familyNumber;a.type=CHART;a.zhuType="people";a.roomName=b.name;a.value=b.familyNumber;scene.add(a);zhus.push(a)}}else{for(index in zhus){var e=zhus[index];e.position.set(e.position.x,currentOutFloor.position.y+floorHeight/2+2,e.position.z)}}zhuMove(d,zhus,"people")}function zhuMove(c,f,b){for(index in f){var e=f[index].position.y-zOriginalHeight/2+(f[index].value*zOriginalHeight)/2;var d=new TWEEN.Tween(f[index].scale);d.to({x:1,y:f[index].value==0?0.01:f[index].value,z:1},1000).easing(TWEEN.Easing.Exponential.InOut).start();f[index].scaleTween=d;var a=new TWEEN.Tween(f[index].position);a.to({x:f[index].position.x,y:e,z:f[index].position.z},1000).easing(TWEEN.Easing.Exponential.InOut).start();f[index].positionTween=a}setTimeout(function(){text3DShow(c,b)},1000)}function zhuDisappear(a,d,c){for(var b=0;b<a.length;b++){new TWEEN.Tween(a[b].scale).to({x:1,y:0.01,z:1},500).easing(TWEEN.Easing.Exponential.InOut).start()}setTimeout(function(){removeAllZhu(a,c)},500);text3DDisappear(d,c)}function removeAllZhu(a,c){for(var b=0;b<a.length;b++){scene.remove(a[b])}if(c=="all"){zhus=[];incomeZhu=[];costZhu=[];orderNumZhu=[];orderbookZhu=[]}else{if(c=="people"){zhus=[]}else{if(c=="income"){incomeZhu=[]}else{if(c=="cost"){costZhu=[]}else{if(c=="orderNum"){orderNumZhu=[]}else{if(c=="orderbook"){orderbookZhu=[]}}}}}}if(currentOutFloor!=null){if(zhuEnable==true&&c=="people"){zhuShow(currentOutFloor)}if(incomeEnable==true&&c=="income"){incomeShow(currentOutFloor)}if(costEnable==true&&c=="cost"){costShow(currentOutFloor)}if(orderNumEnable==true&&c=="orderNum"){orderNumShow(currentOutFloor)}if(orderbookEnable==true&&c=="orderbook"){orderbookShow(currentOutFloor)}}}function incomeShow(d){if(incomeEnable==false){return}if(currentOutFloor==null){return}if(currentOutFloor.name!=d.name){return}var c=new Date();if((c.getTime()-d.startMoveTime.getTime())<1000){return}if(incomeZhu.length==0){for(index in houseTypes){var b=houseTypes[index];var f=new THREE.CubeGeometry(zwidth,zOriginalHeight,zwidth);var a=new THREE.Mesh(f,new THREE.MeshPhongMaterial({color:incomeColor,opacity:0.5,transparent:true}));a.position.set(b.position.x-(evX/2-zwidth/2)+zwidth/2,b.position.y+zOriginalHeight/2,b.position.z-(evZ/2-zwidth)+zwidth+4);a.material.side=THREE.DoubleSide;a.name=b.income;a.familyNumber=b.familyNumber;a.type=CHART;a.zhuType="income";a.roomName=b.name;a.value=b.income;scene.add(a);incomeZhu.push(a)}}else{for(index in incomeZhu){var e=incomeZhu[index];e.position.set(e.position.x,currentOutFloor.position.y+floorHeight/2+2,e.position.z)}}zhuMove(d,incomeZhu,"income")}function incomeHide(){zhuDisappear(incomeZhu,incomeText,"income")}function costShow(d){if(costEnable==false){return}if(currentOutFloor==null){return}if(currentOutFloor.name!=d.name){return}var c=new Date();if((c.getTime()-d.startMoveTime.getTime())<1000){return}if(costZhu.length==0){for(index in houseTypes){var b=houseTypes[index];var f=new THREE.CubeGeometry(zwidth,zOriginalHeight,zwidth);var a=new THREE.Mesh(f,new THREE.MeshPhongMaterial({color:costColor,opacity:0.5,transparent:true}));a.position.set(b.position.x-(evX/2-zwidth/2)+zwidth/2,b.position.y+zOriginalHeight/2,b.position.z-(evZ/2-zwidth)+(zwidth+4)*2);a.material.side=THREE.DoubleSide;a.name=b.cost;a.type=CHART;a.familyNumber=b.familyNumber;a.zhuType="cost";a.roomName=b.name;a.value=b.cost;scene.add(a);costZhu.push(a)}}else{for(index in costZhu){var e=costZhu[index];e.position.set(e.position.x,currentOutFloor.position.y+floorHeight/2+2,e.position.z)}}zhuMove(d,costZhu,"cost")}function costHide(){zhuDisappear(costZhu,costText,"cost")}function orderNumShow(d){if(orderNumEnable==false){return}if(currentOutFloor==null){return}if(currentOutFloor.name!=d.name){return}var c=new Date();if((c.getTime()-d.startMoveTime.getTime())<1000){return}if(orderNumZhu.length==0){for(index in houseTypes){var b=houseTypes[index];var f=new THREE.CubeGeometry(zwidth,zOriginalHeight,zwidth);var a=new THREE.Mesh(f,new THREE.MeshPhongMaterial({color:orderNumColor,opacity:0.5,transparent:true}));a.position.set(b.position.x-(evX/2-zwidth/2)+zwidth/2,b.position.y+zOriginalHeight/2,b.position.z-(evZ/2-zwidth)+(zwidth+4)*3);a.material.side=THREE.DoubleSide;a.name=b.orderNum;a.familyNumber=b.familyNumber;a.type=CHART;a.zhuType="orderNum";a.roomName=b.name;a.value=b.orderNum;scene.add(a);orderNumZhu.push(a)}}else{for(index in orderNumZhu){var e=orderNumZhu[index];e.position.set(e.position.x,currentOutFloor.position.y+floorHeight/2+2,e.position.z)}}zhuMove(d,orderNumZhu,"orderNum")}function orderNumHide(){zhuDisappear(orderNumZhu,orderNumText,"orderNum")}function orderbookShow(d){if(orderbookEnable==false){return}if(currentOutFloor==null){return}if(currentOutFloor.name!=d.name){return}var c=new Date();if((c.getTime()-d.startMoveTime.getTime())<1000){return}if(orderbookZhu.length==0){for(index in houseTypes){var b=houseTypes[index];var f=new THREE.CubeGeometry(zwidth,zOriginalHeight,zwidth);var a=new THREE.Mesh(f,new THREE.MeshPhongMaterial({color:orderbookColor,opacity:0.5,transparent:true}));a.position.set(b.position.x-(evX/2-zwidth/2)+zwidth/2,b.position.y+zOriginalHeight/2,b.position.z-(evZ/2-zwidth)+(zwidth+4)*4);a.material.side=THREE.DoubleSide;a.name=b.orderbook;a.familyNumber=b.familyNumber;a.type=CHART;a.zhuType="orderbook";a.roomName=b.name;a.value=b.orderbook;scene.add(a);orderbookZhu.push(a)}}else{for(index in orderbookZhu){var e=orderbookZhu[index];e.position.set(e.position.x,currentOutFloor.position.y+floorHeight/2+2,e.position.z)}}zhuMove(d,orderbookZhu,"orderbook")}function orderbookHide(){zhuDisappear(orderbookZhu,orderbookText,"orderbook")}function text2DShow(){for(index in zhus){var c=zhus[index].position.y+(zhus[index].familyNumber*zOriginalHeight)/2;var e=document.createElement("canvas");e.height=30;e.width=30;var f=e.getContext("2d");f.font="500 38px normal";f.fillStyle="rgba(255,82,42,0.95)";f.fillText(zhus[index].familyNumber,0,30);var g=new THREE.Texture(e);g.needsUpdate=true;var b=new THREE.MeshBasicMaterial({map:g,color:16777215});b.transparent=true;var a=new THREE.PlaneGeometry(40,15);var d=new THREE.Mesh(a,b);d.position.set(zhus[index].position.x,c,zhus[index].position.z);d.context=f;d.texture=g;scene.add(d)}}function textSingleShow(f,c,i){if(i=="people"&&zhuEnable==false){return}else{if(i=="income"&&incomeEnable==false){return}else{if(i=="cost"&&costEnable==false){return}else{if(i=="orderNum"&&orderNumEnable==false){return}else{if(i=="orderbook"&&orderbookEnable==false){return}}}}}if(currentOutFloor.name!=f.name){return}var l=c.position.y+(c.value*zOriginalHeight)/2+2;var e=new THREE.MeshBasicMaterial({color:16777215});var d=new THREE.MeshBasicMaterial({color:136});var k=[e,d];var j=new THREE.TextGeometry(c.value,{size:fontSize3D,height:1,curveSegments:1,font:"helvetiker",weight:"bold",style:"normal",bevelThickness:1,bevelSize:1,bevelEnabled:true,material:0,extrudeMaterial:1});var b=new THREE.MeshFaceMaterial(k);var a=new THREE.Mesh(j,b);j.computeBoundingBox();var g=j.boundingBox.max.x-j.boundingBox.min.x;var h=c.position.z+g/2;a.position.set(c.position.x,l,h);a.rotation.y=Math.PI/2;a.contentType="text3D";scene.add(a);if(i=="people"){text3Ds.push(a)}else{if(i=="income"){incomeText.push(a)}else{if(i=="cost"){costText.push(a)}else{if(i=="orderNum"){orderNumText.push(a)}else{if(i=="orderbook"){orderbookText.push(a)}}}}}}function text3DShow(g,k){var n=null;var c=null;if(k=="people"&&zhuEnable==false){return}else{if(k=="income"&&incomeEnable==false){return}else{if(k=="cost"&&costEnable==false){return}else{if(k=="orderNum"&&orderNumEnable==false){return}else{if(k=="orderbook"&&orderbookEnable==false){return}}}}}if(currentOutFloor.name!=g.name){return}if(k=="people"){n=zhus;c=text3Ds}else{if(k=="income"){n=incomeZhu;c=incomeText}else{if(k=="cost"){n=costZhu;c=costText}else{if(k=="orderNum"){n=orderNumZhu;c=orderNumText}else{if(k=="orderbook"){n=orderbookZhu;c=orderbookText}}}}}if(c.length>0){for(var d=0;d<c.length;d++){scene.remove(c[d])}}for(index in n){var o=n[index].position.y+(n[index].value*zOriginalHeight)/2+2;var f=new THREE.MeshBasicMaterial({color:16777215});var e=new THREE.MeshBasicMaterial({color:136});var m=[f,e];var l=new THREE.TextGeometry(n[index].value,{size:fontSize3D,height:1,curveSegments:1,font:"helvetiker",weight:"bold",style:"normal",bevelThickness:1,bevelSize:1,bevelEnabled:true,material:0,extrudeMaterial:1});var b=new THREE.MeshFaceMaterial(m);var a=new THREE.Mesh(l,b);l.computeBoundingBox();var h=l.boundingBox.max.x-l.boundingBox.min.x;var j=n[index].position.z+h/2;a.position.set(n[index].position.x,o,j);a.rotation.y=Math.PI/2;a.contentType="text3D";scene.add(a);if(k=="people"){text3Ds.push(a)}else{if(k=="income"){incomeText.push(a)}else{if(k=="cost"){costText.push(a)}else{if(k=="orderNum"){orderNumText.push(a)}else{if(k=="orderbook"){orderbookText.push(a)}}}}}}}function text3DDisappear(b,a){for(index in b){scene.remove(b[index])}if(a=="people"){text3Ds=[]}else{if(a=="income"){incomeText=[]}else{if(a=="cost"){costText=[]}else{if(a=="orderNum"){orderNumText=[]}else{if(a=="orderbook"){orderbookText=[]}}}}}}function animate(){requestAnimationFrame(animate);render();update()}function update(){var b=new THREE.Vector3(mouse.x,mouse.y,1);projector.unprojectVector(b,camera);var a=new THREE.Raycaster(camera.position,b.sub(camera.position).normalize());var f=a.intersectObjects(scene.children);if(f.length>0){if(f[0].object.contentType=="text3D"){return}if(f[0].object!=INTERSECTED){if(INTERSECTED){INTERSECTED.material.color.setHex(INTERSECTED.currentHex)}INTERSECTED=f[0].object;INTERSECTED.currentHex=INTERSECTED.material.color.getHex();if(f[0].object.type!=GROUND){INTERSECTED.material.color.setHex(8434687)}if(f[0].object.name){context1.clearRect(0,0,640,480);var e=f[0].object.name;var d=context1.measureText(e);var c=d.width;context1.fillStyle="rgba(0,0,0,0.95)";context1.fillRect(0,0,c+8,20+8);context1.fillStyle="rgba(255,255,255,0.95)";context1.fillRect(2,2,c+4,20+4);context1.fillStyle="rgba(0,0,0,1)";context1.fillText(e,4,20);texture1.needsUpdate=true}else{context1.clearRect(0,0,300,300);texture1.needsUpdate=true}}}else{if(INTERSECTED){INTERSECTED.material.color.setHex(INTERSECTED.currentHex)}INTERSECTED=null;context1.clearRect(0,0,300,300);texture1.needsUpdate=true}controls.update();stats.update()}function render(){TWEEN.update();renderer.clear();renderer.render(scene,camera)};